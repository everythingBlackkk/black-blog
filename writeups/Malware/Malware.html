<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Malware VM Detection Techniques</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="../../Media/logo.png" type="image/x-icon" sizes="64x64">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/atom-one-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <link rel="stylesheet" href="../THM-Brains-Arb/Brains.css">
    <style>
        body {
            direction: ltr;
            text-align: left;
        }
        .code {
            direction: ltr;
            text-align: left;
            unicode-bidi: bidi-override;
        }
        .important-text {
            color: #3498db;
            font-weight: bold;
        }
        .section-spacing {
            margin-bottom: 3rem;
        }
        .image-spacing {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body class="custom-bg text-white font-sans">
    <div class="flex flex-row">
        <!-- Left Section -->
        <div class="left-section">
            <div class="content-wrapper text-center">
                <img src="../../Media/everythingBlackkk.png" alt="Profile" class="rounded-full w-48 h-48 mb-4 mx-auto relative z-10">
                <h1 class="text-5xl font-bold gradient-text">Yassin Abdelrazik</h1>
                <p class="text-xl text-gray-400">penetration tester | Red Team</p>
                <a href="https://mail.google.com/mail/?view=cm&fs=1&to=snpxblack2006@gmail.com">
                    <button class="py-2 px-4 bg-gray-700 text-white rounded-lg hover-email text-sm md:text-base">
                        Email Me
                    </button>
                </a>
            </div>
        </div>

        <!-- Right Section -->
        <div class="right-section">
            <div class="Sahm">
                <a href="../../index.html" class="home-btn" style="font-size: 24px; display: flex; align-items: center;">
                    <div style="background-color: rgba(128, 128, 128, 0.6); border-radius: 12px; padding: 10px 20px; display: flex; align-items: center; backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.5);">
                        <span style="font-size: 24px;">Home Page</span>
                        <a href="../../index.html" style="margin-left: 10px; display: flex; align-items: center;">
                            <div style="background-color: gray; border-radius: 50%; padding: 5px; display: flex; justify-content: center; align-items: center;">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="white">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                </svg>
                            </div>
                        </a>
                    </div>
                </a>
            </div>
            
            <div class="content-wrapper">
                <h1 class="text-4xl font-bold mb-6">Malware VM Detection Techniques</h1>              
                
                <div class="section-spacing">
                    <p class="mb-4">
                        Hello everyone! Today, I'll discuss the techniques used by malware developers to identify if their code is running in a real environment or a virtual machine (VM) so that they can decide whether to proceed with their malicious actions, like encrypting files, stealing information, and other common malware functions. I'll also include a C++ code simulation to demonstrate how malware might detect these environments. Let's jump in!
                    </p>
                    <img src="Mr_Robot.jpg" alt="Introduction Image" class="image-spacing">
                </div>

                <div class="section-spacing">
                    <h2 class="text-2xl font-bold mb-4">1. Registry Keys (Reg Keys)</h2>
                    <p class="mb-4">
                        In simple terms, registry keys are like a huge database that stores system and application settings on a device. So, if you want to modify anything on your system or in a particular app, you'll likely find it in the registry.
                    </p>
                    <p class="mb-4">
                        Registry keys consist of <span class="important-text">keys</span> and <span class="important-text">values</span>, and virtual machines often have specific registry entries that hint at their virtual environment. For example, a malware could check for keys like <code>HKLM\SYSTEM\CurrentControlSet\Services\VBoxGuest</code>. If the malware finds this key, it confirms it's in a VM environment and may change its behavior or even delete itself.
                    </p>
                    <p class="mb-4">
                        There Is Another Reg key like:
                    </p>
                    <p class="mb-4">
                        I Have A good Way to hide My self in Virtual Machine By Change My Name :)
                    </p>
                    <pre class="code mb-4"><code>HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\VBoxGuest</code></pre>
                    <img src="1.png" alt="Registry Key 1" class="image-spacing">

                    <pre class="code mb-4"><code>HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Control\Class\{4D36E968-E325-11CE-BFC1-08002BE10318}\000\DriverDesc</code></pre>
                    <img src="22.png" alt="Registry Key 2" class="image-spacing">

                    <pre class="code mb-4"><code>HKEY_LOCAL_MACHINE\HARDWARE\DEVICEMAP\Scsi\Scsi Port 0\Scsi Bus 0\Target Id 0\Logical Unit Id 0</code></pre>
                    <img src="3.png" alt="Registry Key 3" class="image-spacing">
                </div>

                <div class="section-spacing">
                    <h2 class="text-2xl font-bold mb-4">2. MAC Address</h2>
                    <p class="mb-4">
                        Every device has a unique MAC address. However, VMs have particular MAC addresses specific to their platforms, like <code>00:50:56</code> for VMware and <code>08-00-27</code> for VirtualBox. By detecting these, malware can determine if it's in a VM environment and adjust its actions accordingly.
                    </p>
                    <img src="5.png" alt="MAC Address" class="image-spacing">
                </div>

                <div class="section-spacing">
                    <h2 class="text-2xl font-bold mb-4">3. Processes</h2>
                    <p class="mb-4">
                        Malware often inspects running processes in the system to look for VM-specific ones. For example, processes like <code>VBoxService.exe</code> or <code>vmtoolsd.exe</code>  indicate that the system is running on a virtual machine, which is a red flag for malware to alter its behavior.
                    </p>
                    <img src="6.png" alt="MAC Address" class="image-spacing">
                </div>

                <div class="section-spacing">
                    <h2 class="text-2xl font-bold mb-4">4. BIOS Information</h2>
                    <p class="mb-4">
                        The BIOS in real hardware is usually different from that in virtual machines. For example, the BIOS in VMs may contain information like <code>VirtualBox</code> or <code>VMware</code>  , which malware can detect as a sign it’s in a virtual environment.
                    </p>
                    <pre class="code mb-4"><code>wmic bios get serialnumber</code></pre>
                    <img src="7.png" alt="MAC Address" class="image-spacing">
                </div>

                <div class="section-spacing">
                    <h2 class="text-2xl font-bold mb-4">5. Hardware Checks</h2>
                    <p class="mb-4">
                        Malware can also inspect connected devices to determine if they’re real or virtual. Many VMs use “virtual devices” or “vDevices” to emulate hardware. When malware detects these devices, it may suspect it’s not in a real environment.
                    </p>
                </div>

                <div class="section-spacing bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <h2 class="text-3xl font-bold mb-6 text-blue-400 border-b border-gray-700 pb-3">
                        6. Descriptor Tables
                    </h2>
                    
                    <p class="mb-6 text-gray-300 leading-relaxed">
                        Another method malware uses is by checking the Descriptor Tables: Interrupt Descriptor Table (IDT), Global Descriptor Table (GDT), and Local Descriptor Table (LDT) in the CPU, which contain critical memory access information.
                    </p>

                    <div class="bg-gray-900 rounded-lg p-5 mb-6">
                        <h3 class="text-xl font-semibold mb-4 text-green-400">Quick Overview of Tables:</h3>
                        
                        <div class="space-y-4">
                            <div class="p-3 bg-gray-800 rounded border-l-4 border-blue-500">
                                <span class="font-bold text-blue-400">IDT:</span>
                                <p class="text-gray-300">Manages interrupts, allowing the CPU to stop current code execution to handle immediate actions.</p>
                            </div>

                            <div class="p-3 bg-gray-800 rounded border-l-4 border-green-500">
                                <span class="font-bold text-green-400">GDT:</span>
                                <p class="text-gray-300">Defines memory regions for the entire system, including both OS and user programs.</p>
                            </div>

                            <div class="p-3 bg-gray-800 rounded border-l-4 border-purple-500">
                                <span class="font-bold text-purple-400">LDT:</span>
                                <p class="text-gray-300">Similar to GDT, but it specifically defines memory regions for each individual process.</p>
                            </div>
                        </div>
                    </div>

                    <p class="text-gray-300 leading-relaxed bg-gray-900 p-4 rounded-lg">
                        When both a host and a guest OS are running simultaneously, VMs need to relocate the guest's IDT, GDT, and LDT to avoid conflicts with the host. Malware can detect if it's running in a VM by identifying if these tables have been relocated. This detection is done using specific assembly instructions like <code class="bg-gray-800 px-2 py-1 rounded text-yellow-400">SIDT</code>, <code class="bg-gray-800 px-2 py-1 rounded text-yellow-400">SGDT</code>, and <code class="bg-gray-800 px-2 py-1 rounded text-yellow-400">SLDT</code>, which retrieve the values of IDT, GDT, and LDT, respectively. If malware notices inconsistencies here, it may confirm that it's not in a real environment.
                    </p>
                </div>

                <div class="section-spacing">
                    <h2 class="text-2xl font-bold mb-4">7. System Information</h2>
                    <p class="mb-4">
                        Malware can gather general system information using commands like systeminfo to find details about the device, such as processor type (CPU), memory (RAM), and operating system (OS) type. If it detects that the resources are lower than usual or that the system doesn't seem like a real device, this might be an indicator that it's running in a virtual environment, as VMs often have limited resources.
                    </p>
                    <img src="4.png" alt="System Information" class="image-spacing">
                </div>

                <div class="section-spacing">
                    <h2 class="text-2xl font-bold mb-4">8. Uptime Detection</h2>
                    <p class="mb-4">
                        You can check the system's uptime before the malware is downloaded onto the device. If the system has been running for a long time before the victim receives the malware, it makes more sense. It would be suspicious if the device has only been running for five minutes when the malware gets installed.
                    </p>
                    <pre class="code mb-4"><code class="language-cpp">
#include <iostream>  
#include <windows.h>  
  
int main() {  
    // Use GetTickCount to get the system uptime in milliseconds  
    DWORD uptime = GetTickCount();  
    
    // Convert uptime to minutes  
    DWORD uptimeMinutes = uptime / (1000 * 60);  
    
    if (uptimeMinutes > 60) { // More than 1 hour  
        std::cout << "The system has been running for more than an hour - Real environment.\n";  
    } else if (uptimeMinutes > 30) { // Between 30 minutes and 1 hour  
        std::cout << "The system has been running for more than half an hour - Likely a real environment.\n";  
    } else { // Less than half an hour  
        std::cout << "The system has been running for less than half an hour - Likely a non-real environment.\n";  
    }  
    
    return 0;  
}</code></pre>
                    <p class="mb-4">
                        This code checks that if the device has been running for less than half an hour, then this is in a Virtual Machine environment, and if it is longer, then it may be Real environment.
                    </p>
                    <p class="mb-4">
                        You can check That By PowerShell:
                    </p>
                    <pre class="code mb-4"><code>(get-date) - (gcim Win32_OperatingSystem).LastBootUpTime</code></pre>
                    <img src="7.png" alt="PowerShell Uptime" class="image-spacing">
                    
                    <p class="mb-4">
                        And you can also in CMD:
                    </p>
                    <pre class="code mb-4"><code>systeminfo | find "System Boot Time"</code></pre>
                </div>

                <div class="section-spacing">
                    <h2 class="text-2xl font-bold mb-4">9. Some Information Checks</h2>
                    <p class="mb-4">
                        Lastly, malware might check system details such as the system's uptime or storage capacity. For instance, if the system uptime is unusually low or the storage size is atypical (like 60GB storage with 1GB RAM), these can be clues for malware that it's not in a physical machine.
                    </p>
                    <pre class="code mb-4"><code class="language-cpp">#include &lt;windows.h&gt;
#include &lt;iostream&gt;
#include &lt;string&gt;
#include &lt;filesystem&gt;

bool isVirtualMachine() {
    HKEY hKey;
    const char* regPath = "HARDWARE\\DEVICEMAP\\Scsi\\Scsi Port 0\\Scsi Bus 0\\Target Id 0\\Logical Unit Id 0";
    const char* valueName = "Identifier";
    char value[255];
    DWORD valueSize = sizeof(value);

    if (RegOpenKeyExA(HKEY_LOCAL_MACHINE, regPath, 0, KEY_READ, &hKey) == ERROR_SUCCESS) {

        if (RegQueryValueExA(hKey, valueName, NULL, NULL, (LPBYTE)value, &valueSize) == ERROR_SUCCESS) {
            RegCloseKey(hKey);
            
            std::string identifierValue(value);

            return (identifierValue.find("VBOX") != std::string::npos ||
                    identifierValue.find("vmware") != std::string::npos ||
                    identifierValue.find("virtual") != std::string::npos);
        }
        RegCloseKey(hKey);
    }
    return false;
}

bool isHardDriveSmall() {
    ULARGE_INTEGER freeBytesAvailable, totalNumberOfBytes, totalNumberOfFreeBytes;
    if (GetDiskFreeSpaceExA("C:\\", &freeBytesAvailable, &totalNumberOfBytes, &totalNumberOfFreeBytes)) {

        double sizeGB = static_cast&lt;double&gt;(totalNumberOfBytes.QuadPart) / (1024 * 1024 * 1024);
        return sizeGB < 70;
    }
    return false;
}

bool isRamSmall() {
    MEMORYSTATUSEX memoryStatus;
    memoryStatus.dwLength = sizeof(memoryStatus);
    if (GlobalMemoryStatusEx(&memoryStatus)) {

        double ramGB = static_cast&lt;double&gt;(memoryStatus.ullTotalPhys) / (1024 * 1024 * 1024);
        return ramGB < 2;
    }
    return false;
}

bool isDesktopEmpty() {
    std::string desktopPath = std::string(getenv("USERPROFILE")) + "\\Desktop";
    int fileCount = std::distance(std::filesystem::directory_iterator(desktopPath), std::filesystem::directory_iterator{});
    return fileCount == 0;
}

int main() {
    std::string message;
    
    if (isVirtualMachine()) {
        message += "We are in a virtual machine.\n";
    } else {
        message += "We are on a real machine.\n";
    }

    if (isHardDriveSmall()) {
        message += "- Hard drive is less than 70 GB.\n";
    }
    if (isRamSmall()) {
        message += "- RAM is less than 2 GB.\n";
    }
    if (isDesktopEmpty()) {
        message += "- Desktop is empty.\n";
    }

    MessageBoxA(NULL, message.c_str(), "Environment Check", MB_OK | MB_ICONINFORMATION);
    return 0;
}</code></pre>
                    <div class="section-spacing">
                        <!-- Introduction -->
                        <p class="mb-6">
                            This code is written in C++ and performs checks to detect if it's running in a virtual machine or a physical machine. Here's a detailed explanation of each function and how it works:
                        </p>

                        <!-- isVirtualMachine() -->
                        <div class="mb-8">
                            <p class="mb-4">
                                <strong class="text-xl">isVirtualMachine():</strong>
                            </p>
                            <ul class="list-disc pl-6 space-y-2">
                                <li>This function checks the Windows registry to see if there are any entries that indicate a virtual machine environment, such as VirtualBox, VMware, or any identifier containing "virtual."</li>
                                <li>It opens a registry key located at HARDWARE\DEVICEMAP\Scsi\Scsi Port 0\Scsi Bus 0\Target Id 0\Logical Unit Id 0 and looks for a value named "Identifier".</li>
                                <li>If it finds a value with "VBOX," "vmware," or "virtual" in it, the function returns true, meaning the program is likely running in a virtual machine.</li>
                                <li>Otherwise, it returns false, indicating it's likely running on a real machine.</li>
                            </ul>
                        </div>

                        <!-- isHardDriveSmall() -->
                        <div class="mb-8">
                            <p class="mb-4">
                                <strong class="text-xl">isHardDriveSmall():</strong>
                            </p>
                            <ul class="list-disc pl-6 space-y-2">
                                <li>This function checks if the size of the main hard drive (C:) is less than 70 GB.</li>
                                <li>It uses GetDiskFreeSpaceEx to get the total disk space and calculates the size in gigabytes.</li>
                                <li>If the hard drive is less than 70 GB, the function returns true, which can be an indicator of a virtual environment (where small hard drives are common).</li>
                                <li>Otherwise, it returns false.</li>
                            </ul>
                        </div>

                        <!-- isRamSmall() -->
                        <div class="mb-8">
                            <p class="mb-4">
                                <strong class="text-xl">isRamSmall():</strong>
                            </p>
                            <ul class="list-disc pl-6 space-y-2">
                                <li>This function checks if the system has less than 2 GB of RAM.</li>
                                <li>It uses GlobalMemoryStatusEx to get the total physical memory and converts it to gigabytes.</li>
                                <li>If the RAM is less than 2 GB, it returns true, again possibly indicating a virtual machine (which often has limited RAM).</li>
                                <li>Otherwise, it returns false.</li>
                            </ul>
                        </div>

                        <!-- isDesktopEmpty() -->
                        <div class="mb-8">
                            <p class="mb-4">
                                <strong class="text-xl">isDesktopEmpty():</strong>
                            </p>
                            <ul class="list-disc pl-6 space-y-2">
                                <li>This function checks if the user's Desktop folder is empty.</li>
                                <li>It constructs the path to the Desktop folder using the environment variable USERPROFILE, then counts the number of items in that folder.</li>
                                <li>If there are no files or folders on the Desktop, it returns true, which could suggest a virtual machine or fresh installation.</li>
                                <li>Otherwise, it returns false.</li>
                            </ul>
                        </div>

                        <!-- main() -->
                        <div class="mb-8">
                            <p class="mb-4">
                                <strong class="text-xl">main():</strong>
                            </p>
                            <ul class="list-disc pl-6 space-y-2">
                                <li>The main function combines the results of the above checks and builds a message based on the environment.</li>
                                <li>It checks each condition:</li>
                                <li>If it's a virtual machine, it appends "We are in a virtual machine." Otherwise, it appends "We are on a real machine."</li>
                                <li>If the hard drive is small, it adds a line saying the hard drive is less than 70 GB.</li>
                                <li>If RAM is small, it notes that RAM is less than 2 GB.</li>
                                <li>If the Desktop is empty, it notes that the Desktop is empty.</li>
                                <li>Finally, it displays the message in a message box with an information icon.</li>
                            </ul>
                        </div>

                        <p class="mt-8 text-center text-xl">
                            Wwwwweeeeeeee Are Done :)
                        </p>
                    </div>
                </div>

                <h1 class="text-center mt-8">Made By ❤ everythingBlackkk</h1>
            </div>
        </div>
    </div>

    <div class="pattern-bg"></div>
</body>
</html>